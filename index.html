<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Scanner de Nota</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { text-align: center; font-family: sans-serif; background: #f2f2f2; padding: 30px; }
    #reader { width: 320px; margin: auto; }
    #flipCameraBtn { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Escaneie sua nota</h1>
  <div id="reader"></div>
  <p id="status">Aguardando leitura...</p>
  <button id="flipCameraBtn">Trocar C√¢mera</button>

  <script>
    console.log("üì° Iniciando scanner...");

    let html5QrCode = new Html5Qrcode("reader");
    let usingBackCamera = true; // Come√ßa na c√¢mera traseira

    function startScanner() {
      const facingMode = usingBackCamera ? { exact: "environment" } : "user";

      html5QrCode.start(
        { facingMode: facingMode },
        { fps: 10, qrbox: 250 },
        async decodedText => {
          console.log("‚úÖ QR Code lido:", decodedText);
          document.getElementById("status").innerText = "Enviando para valida√ß√£o...";

          fetch("https://midiasocialpam.wixsite.com/ebookcampeao/_functions/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chave: decodedText })
          })
          .then(response => {
            console.log("üì• Resposta recebida:", response);
            return response.json();
          })
          .then(res => {
            console.log("üì¶ JSON da resposta:", res);
            if (res.ok) {
              document.getElementById("status").innerText = `‚úÖ Pontos creditados: ${res.pontos}`;
            } else {
              document.getElementById("status").innerText = `‚ö†Ô∏è ${res.msg}`;
            }
          })
          .catch(err => {
            console.error("‚ùå Erro:", err);
            document.getElementById("status").innerText = "Erro ao enviar dados.";
          });
        }
      ).catch(err => {
        console.error("‚ùå Erro ao acessar c√¢mera:", err);
        document.getElementById("status").innerText = "Erro ao acessar a c√¢mera. Verifique as permiss√µes.";
      });
    }

    // Fun√ß√£o para inverter c√¢mera
    document.getElementById("flipCameraBtn").addEventListener("click", async () => {
      try {
        await html5QrCode.stop(); // Para o scanner atual
        usingBackCamera = !usingBackCamera; // Alterna c√¢mera
        startScanner(); // Reinicia scanner
      } catch (err) {
        console.error("Erro ao alternar c√¢mera:", err);
      }
    });

    // Iniciar o scanner quando carregar a p√°gina
    startScanner();
  </script>
</body>
</html>
